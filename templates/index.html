{% extends 'base.html' %}
{% block content %}
<h1 class="text-2xl font-semibold mb-4">Today</h1>

<div class="grid gap-4">
  {% for habit in habits %}
  <div class="card rounded-2xl p-4">   
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-3 h-3 rounded-full" style="background:{{ habit.color }};"></div>
        <div class="font-medium">{{ habit.name }}</div>
        <span id="streak-{{habit.id}}" class="text-xs opacity-60">
          Streak: {{ streaks[habit.id] }} ðŸ”¥
        </span>
      </div>

      {% set checked = (habit.id, today) in Check_map %}
      <button
        data-hid="{{ habit.id }}"
        data-date="{{ today.isoformat() }}"
        class="toggle px-3 py-1.5 rounded-lg text-sm border border-white/10 
               {% if checked %}bg-emerald-500/30{% else %}bg-slate-800{% endif %}">
        {% if checked %}Done{% else %}Mark done{% endif %}
      </button>
    </div>

    <div class="mt-3 text-xs opacity-80">This week</div>
    <div class="mt-2 grid grid-cols-7 gap-2">
      {% for day in days %}
        {% set on = (habit.id, day) in Check_map %}
        <button
          data-hid="{{ habit.id }}"
          data-date="{{ day.isoformat() }}"
          class="day-toggle h-8 rounded-lg border border-white/10 text-xs 
                 {% if on %}bg-emerald-500/30{% else %}bg-slate-800{% endif %}
                 {% if day == today %}ring-2 ring-emerald-400/30{% endif %}"
          {% if day > today %}disabled{% endif %}>
          {{ day.strftime('%a') }}
        </button>
      {% endfor %}
    </div>


    <div class="mt-4">
      <canvas id="chart-{{ habit.id }}" height="80" class="habit-chart" data-habit-id="{{ habit.id }}"></canvas>
    </div>
  </div>
  {% endfor %}
</div>

<h2 class="text-xl font-semibold mt-8 mb-2">Weekly Check-ins (All Habits)</h2>
<canvas id="overall-chart" height="120"></canvas>

<script>

if (!window.ActiveCharts) window.ActiveCharts = {};

function destroyChart(id) {
    if (window.ActiveCharts[id]) {
        window.ActiveCharts[id].destroy();
        window.ActiveCharts[id] = null;
    }
}


function loadHabitCharts() {
  document.querySelectorAll('.habit-chart').forEach(canvas => {
    const habitId = canvas.dataset.habitId;
    const chartId = `chart-${habitId}`;
    
    fetch(`/analytics/habit/${habitId}.json`)
      .then(r => r.json())
      .then(({ labels, data, color, name }) => {
        const ctx = canvas.getContext("2d");
        

        destroyChart(chartId);
        
        window.ActiveCharts[chartId] = new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [{
              label: name,
              data,
              backgroundColor: color + '80', 
              borderRadius: 4,
              borderColor: color,
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { 
              y: { 
                beginAtZero: true, 
                max: 1,
                ticks: { stepSize: 1 }
              },
              x: { ticks: { font: { size: 10 } } }
            },
            plugins: {
              legend: { display: false },
              title: { 
                display: true, 
                text: 'This Week',
                font: { size: 12 }
              }
            }
          }
        });
      });
  });
}


function loadOverallChart() {
  fetch("/analytics.json")
    .then(r => r.json())
    .then(({ labels, data }) => {
      const canvasId = "overall-chart";
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;

      const ctx = canvas.getContext("2d");

      destroyChart(canvasId);

      window.ActiveCharts[canvasId] = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Total Check-ins",
            data,
            backgroundColor: "rgba(16, 185, 129, 0.5)",
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true, precision: 0 } }
        }
      });
    });
}

function loadAllCharts() {
  loadHabitCharts();
  loadOverallChart();
}

loadAllCharts(); 
document.addEventListener("DOMContentLoaded", () => {

  async function sendToggle(habit_id, dateIso) {
    try {
      const resp = await axios.post('/toggle', { habit_id, date: dateIso });
      return resp.data;
    } catch (err) {
      console.error(err);
      return null;
    }
  }

  const buttons = document.querySelectorAll(".toggle, .day-toggle");

  buttons.forEach(btn => {
    btn.addEventListener("click", async () => {

      const habit_id = btn.dataset.hid;
      const date = btn.dataset.date;

      btn.disabled = true;
      const result = await sendToggle(habit_id, date);
      btn.disabled = false;

      if (!result || !result.ok) {
        alert("Could not update. Try again.");
        return;
      }

      const checked = result.checked;


      if (btn.classList.contains("toggle")) {
        btn.textContent = checked ? "Done" : "Mark done";
      }

      btn.classList.toggle("bg-slate-800", !checked);
      btn.classList.toggle("bg-emerald-500/30", checked);


      const streakEl = document.getElementById(`streak-${habit_id}`);
      if (streakEl && result.streak !== undefined) {
        streakEl.textContent = `Streak: ${result.streak} ðŸ”¥`;
      }


      loadAllCharts();
    });
  });
});
</script>
{% endblock %}